const fs = require("fs");

if (!fs.existsSync("sqlite-backup.sql")) {
  console.error(
    '❌ File "sqlite-backup.sql" not found. Run this first: sqlite3 .tmp/data.db .dump > sqlite-backup.sql'
  );
  process.exit(1);
}

let sql = fs.readFileSync("sqlite-backup.sql", "utf8");

// Convert SQLite SQL to Postgres-friendly SQL
sql = sql
  .replace(/PRAGMA.*;/g, "")
  .replace(/BEGIN TRANSACTION;/g, "")
  .replace(/COMMIT;/g, "")
  .replace(/AUTOINCREMENT/g, "GENERATED BY DEFAULT AS IDENTITY")
  .replace(/"([^\"]+)" TEXT/g, (m) => m.replace("TEXT", "VARCHAR"))
  .replace(/"([^\"]+)" INTEGER/g, (m) => m.replace("INTEGER", "INT"))
  .replace(/datetime\('now'\)/g, "CURRENT_TIMESTAMP");

fs.writeFileSync("postgres-data.sql", sql);

console.log("✅ Converted successfully → postgres-data.sql");
